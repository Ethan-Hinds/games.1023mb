<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
</head>

<body>

    <textarea id="input" rows="30" cols="50"></textarea>
    <textarea id="output" rows="30" cols="50" readonly></textarea>
    <br>
    <button onclick="compile()">Run</button>
    <br>
    <br>
    <textarea id="variables" rows="10" cols=30" readonly>Variables:</textarea>

    <script>

        let lines;
        let numBlock = 0;
        let variables = {};
        let operators = ["&&", "||", ",", "+", "-", "*", "/", "<=", ">=", ">", "<", "=="];
        let onLine = 0;
        let loopInfo = undefined;

        document.getElementById("input").value = "x := 9\ny := 10\nif (x + 2) > y\nprint(x)\n  while(x<20)\n    x := x*2\n  end\n  print(x+2)\nend";

        function compile() {

            variables = {};
            onLine = 0;
            document.getElementById("output").value = "";
            loopInfo = undefined;
            numBlock = 0;

            lines = document.getElementById("input").value.split("\n");
            for (let i = 0; i < lines.length; i += 1) {
                lines[i] = lines[i].replace(/\s+/g, "");
            }

            while (onLine < lines.length) {
                evaluateLine(onLine);
                if (!loopInfo || onLine < loopInfo[1]) {
                    onLine += 1;
                } else {
                    onLine = loopInfo[0];
                }


                let variablesStr = "";
                for (let key in variables) {
                    if (key != "output") {
                        variablesStr += `${key}: ${variables[key]}\n`;
                    }
                }
                document.getElementById("variables").value = variablesStr;
            }
        }

        function evaluateLine() {
            let line = lines[onLine];
            if (line.indexOf(":=") >= 0) {
                let opIndex = line.indexOf(":=")
                let left = line.slice(0, opIndex);
                let right = line.slice(opIndex + ":=".length);
                variables[left] = evaluateCondition(right).toString();
            }
            if (line.slice(0, 5) == "print") {
                let expression = line.slice("print".length + 1, line.length - 1);
                variables["output"] = expression;
                document.getElementById("output").value += evaluateCondition(variables.output) + "\n";
            }
            if (line.slice(0, 2) == "if") {
                numBlock += 1;
                let endLine = findBlockEnd();
                let statement = line.slice("if".length);
                if (!evaluateCondition(statement)) {
                    onLine = endLine - 1;
                }
            }
            if (line.slice(0,5) == "while") {
                if (!loopInfo) {
                    numBlock += 1;
                }
                let endLine = findBlockEnd();
                let statement = line.slice("while".length);
                if (!evaluateCondition(statement)) {
                    onLine = endLine-1;
                    loopInfo = undefined;
                } else if (!loopInfo) {
                    loopInfo = [onLine, endLine];
                }
            }
        }


        function findBlockEnd() {
            let num = 0;
            for (let i = lines.length; i >= 0; i -= 1) {
                if (lines[i] == "end") {
                    num += 1;
                    if (num == numBlock) {
                        return i;
                    }
                }
            }
        }


        function evaluateCondition(expression) {
            if (!isNaN(expression)) {
                return parseFloat(expression);
            }
            if (variables.hasOwnProperty(expression)) {
                return variables[expression];
            }
            if (expression == "true" || expression == "(true)") {
                return true;
            }
            if (expression == "false" || expression == "(false)") {
                return false;
            }

            let deepestLevel = 0;
            let level = 0;
            for (let char of expression) {
                if (char == "(") {
                    level += 1;
                    deepestLevel = Math.max(deepestLevel, level);
                } else if (char == ")") {
                    level -= 1;
                }
            }

            if (deepestLevel == 0) {

                // Find the index of the last operator
                let index = expression.length;
                let operator = "";
                for (let _operator of operators) {
                    let opIndex = expression.indexOf(_operator);
                    if (opIndex >= 0 && opIndex < index) {
                        index = opIndex;
                        operator = _operator;
                    }
                }

                let left = expression.slice(0, index);
                let right = expression.slice(index + operator.length);

                if (operator == "&&") {
                    return evaluateCondition(left) && evaluateCondition(right);
                } else if (operator == "||") {
                    return (evaluateCondition(left) || evaluateCondition(right));
                } else if (operator == "<=") {
                    return evaluateCondition(left) <= evaluateCondition(right);
                } else if (operator == ">=") {
                    return evaluateCondition(left) >= evaluateCondition(right);
                } else if (operator == "<") {
                    return evaluateCondition(left) < evaluateCondition(right);
                } else if (operator == ">") {
                    return evaluateCondition(left) > evaluateCondition(right);
                } else if (operator == "+") {
                    return parseFloat(evaluateCondition(left)) + parseFloat(evaluateCondition(right));
                } else if (operator == "-") {
                    return parseFloat(evaluateCondition(left)) - parseFloat(evaluateCondition(right));
                } else if (operator == "*") {
                    return parseFloat(evaluateCondition(left)) * parseFloat(evaluateCondition(right));
                } else if (operator == "/") {
                    return parseFloat(evaluateCondition(left)) / parseFloat(evaluateCondition(right));
                } else if (operator == ",") {
                    return evaluateCondition(left).toString().concat(evaluateCondition(right));
                } else if (operator == "==") {
                    return evaluateCondition(left) == evaluateCondition(right);
                }
            } else {
                let level = 0;

                let indices = [];
                for (let i = 0; i < expression.length; i += 1) {
                    if (expression[i] == "(") {
                        level += 1;
                        if (level == deepestLevel) {
                            indices.push(i + 1);
                        }
                    } else if (expression[i] == ")") {
                        if (level == deepestLevel) {
                            indices.push(i);
                            break;
                        }
                        level -= 1;
                    }
                }

                let section = expression.slice(indices[0], indices[1]);
                let before = expression.slice(0, indices[0] - 1);
                let after = expression.slice(indices[1] + 1);

                expression = before + evaluateCondition(section) + after;
                return evaluateCondition(expression);
            }
        }

    </script>

</body>

</html>
