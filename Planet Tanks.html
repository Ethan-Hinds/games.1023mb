<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.11/p5.js"></script> <!--p5-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
</head>

<body>
<canvas> </canvas>

<label for = "power"> Power </label>
<input type = "range" id = "power" min = "0" max = "100">

<label for = "angle"> Angle </label>
<input type = "range" id = "angle" min = "0" max = "6.283185" step = "0.05">

<button type = "button" onclick = "fire()"> Fire </button>

<div style = "display: none">

	<img id = "tank" src = "http://www.clker.com/cliparts/6/9/O/4/2/M/gray-tank-hi.png" width = "20" height = "20">

</div>

</body>

<script>

var canvas;
var c;
var width;
var height;

var planets = [];
var tanks = [];

var turn = 0;

var bullet;

let numberOfTanks = 2;

function setup() {

	canvas = document.querySelector("canvas");
	c = canvas.getContext("2d");
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight - 150;
	width = canvas.width;
	height = canvas.height;

	placePlanets();
	placeTanks();

}

function Planet(x, y, radius) {
	this.x = x;
	this.y = y;
	this.radius = radius

	this.mass = 2.5 * (radius ** 2);

	this.drawPlanet = function() {
		c.beginPath();
		c.fillStyle = "red";
		c.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
		c.fill();
		c.closePath();

	}
}

function Bullet(tank, x, y, dx, dy, guide) {
	this.tank = tank;
	this.trail = [];
	this.x = x;
	this.y = y;
	this.dx = dx;
	this.dy = dy;
	this.ax = 0;
	this.ay = 0;
	this.guide = guide;

	this.drawBullet = function() {
		for (var i = 0; i < this.trail.length; i += 1) {
			let point = this.trail[i];
			c.beginPath();
			c.fillStyle = "blue";
			c.arc(point[0], point[1], 2, 0, 2 * Math.PI);
			c.fill();
			c.closePath();
		}
	}

	this.moveBullet = function() {

		let netForce = this.getNetForce();
		this.ax = netForce[0] / 1;
		this.ay = netForce[1] / 1;
		this.dx += this.ax;
		this.dy += this.ay;
		this.x += this.dx;
		this.y += this.dy;
		this.trail.push([this.x, this.y])


	}

	this.getNetForce = function() {

		var netX = 0;
		var netY = 0;

		for (var i = 0; i < planets.length; i += 1) {
			let planet = planets[i];

			let radius = getDistanceFromPlanet(planet, this.x, this.y);
			let magnitude = planet.mass / (radius ** 2);
			let yDistance = planet.y - this.y;
			let xDistance = planet.x - this.x;
			let angle = Math.atan(Math.abs(yDistance / xDistance));
			let xComponent = magnitude * Math.cos(angle);
			let yComponent = magnitude * Math.sin(angle);

			if (planet.x < this.x) {
				xComponent *= -1;
			}
			if (planet.y < this.y) {
				yComponent *= -1;
			}

			netX += xComponent;
			netY += yComponent;
		}

		return [netX, netY];
	}

}

function Tank(x, y, angle, planet) {
	this.planet = planet;
	this.angle = angle;
	this.x = x;
	this.y = y;

	this.drawTank = function() {
		let img = document.getElementById("tank");
		drawRotatedImage(img, this.x + 10*Math.cos(this.angle), this.y + 10*Math.sin(this.angle), this.angle + Math.PI / 2);
	}

	this.move = function(direction) {
		if (direction == "left") {
			this.angle -= Math.PI/50;
		} else {
			this.angle += Math.PI/50;
		}
		this.x = this.planet.x + this.planet.radius * Math.cos(this.angle);
		this.y = this.planet.y + this.planet.radius * Math.sin(this.angle);
	}
}

function placePlanets() {

	planets = [];

	let numberOfPlanets = getRandomInt(3, 8);
	while (planets.length < numberOfPlanets) {
		let planetRadius = getRandomInt(20, 50);
		let planetX = getRandomInt(planetRadius, width - planetRadius);
		let planetY = getRandomInt(planetRadius, height - planetRadius);

		var canPlace = true;

		for (var i = 0; i < planets.length; i += 1) {
			if (getDistanceFromPlanet(planets[i], planetX, planetY) < planetRadius + planets[i].radius + 50) {
				canPlace = false;
			}
		}

		if (canPlace) {
			planets.push(new Planet(planetX, planetY, planetRadius));
		}
	}
}

function placeTanks() {

	tanks = [];

	while (tanks.length < numberOfTanks) {
		let planetIndex = getRandomInt(0, planets.length - 1);

		var canPlace = true;

		for (var i = 0; i < tanks.length; i += 1) {
			if (tanks[i].planet == planets[planetIndex]) {
				canPlace = false;
			}
		}

		if (canPlace) {
			let angle = Math.random() * 2 * Math.PI;
			let x = planets[planetIndex].x + planets[planetIndex].radius * Math.cos(angle);
			let y = planets[planetIndex].y + planets[planetIndex].radius * Math.sin(angle);

			tanks.push(new Tank(x, y, angle, planets[planetIndex]));
		}
	}

	bullet = new Bullet(tanks[0], tanks[0].x, tanks[0].y, $("#power").val() * Math.cos($("#angle").val()), $("#power").val() * Math.sin($("#power").val()), true);

}

function draw() {

	c.clearRect(0, 0, width, height);

	for (var i = 0; i < planets.length; i += 1) {
		planets[i].drawPlanet();
	}

	for (var i = 0; i < tanks.length; i += 1) {
		tanks[i].drawTank();
	}

	bullet.drawBullet();

	if (bullet.guide) {
		if (bullet.trail.length < 30) {
			bullet.moveBullet();
		}
	} else {
		var notInPlanet = true;
		for (var i = 0; i < planets.length; i += 1) {
			if (getDistanceFromPlanet(planets[i], bullet.x, bullet.y) < planets[i].radius) {
				notInPlanet = false;
			}
		}

		if (notInPlanet && bullet.trail.length < 200) {
			bullet.moveBullet();
		} else {
			turn = (turn + 1) % numberOfTanks;
			bullet.guide = true;
		}
	}

}

function getDistanceFromPlanet(planet, x, y) {
	let xDistance = x - planet.x;
	let yDistance = y - planet.y;
	return Math.sqrt(xDistance ** 2 + yDistance ** 2);
}

function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function drawRotatedImage(image, x, y, angle) { 
	c.save(); 
	c.translate(x, y);
	c.rotate(angle);
	c.drawImage(image, -(image.width/2), -(image.height/2), 20, 20);
	c.restore(); 
}

$("#power").change(function() {
	fireBullet(true, tanks[turn]);
});

$("#angle").change(function() {
	fireBullet(true, tanks[turn]);
});

function fireBullet(guide, tank) {

	let power = $("#power").val();
	let angle = $("#angle").val();
	bullet = new Bullet(tank, tank.x, tank.y, power * Math.cos(angle), power * Math.sin(angle), guide);

}

function fire() {

	fireBullet(false, tanks[turn]);
}

$(document).keydown(function() {

	direction = event.keyCode
	switch (direction) {
		case 37:
	 		tanks[turn].move("left");
	 		break;
	 	case 39:
	 		tanks[turn].move("right");	
	 		break;
	}	
});


</script>


<style>

</style>

</html>