<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.11/p5.js"></script> <!--p5-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
</head>

<body>

<canvas> </canvas>

</body>

<script>

var c;
var width;
var height;
var ball;
var paddle;

var brickWidth = 50;
var brickHeight = 15;

var brickFallSpeed = 0.1;
var paddleSpeed = 15;
var ballSpeed = 10;

var bricks = [];

var globalLevel = 1;

function setup() {

	var canvas = document.querySelector("canvas");
	c = canvas.getContext("2d");
	canvas.width = window.innerWidth - 50;
	canvas.height = window.innerHeight - 50;
	width = canvas.width;
	height = canvas.height;

	 ball = new Ball(width / 2, 100, 10, 0, ballSpeed);
	 paddle = new Paddle(width / 2, height * 0.9, 100, 15);

	 setLevel(1);


}

var playerLives = 3;

function setLevel(level) {

	globalLevel = level;

	bricks = [];

	ball.x = -100;
	ball.y = -100;
	ball.dx = 0;
	ball.dy = 0;

	paddle.x = -100;
	paddle.y = -100

	switch (level) {
		case 1:

			ballSpeed = 10;
			paddleSpeed = 15;
			brickFallSpeed = 0.1;

			ball.x = width / 2;
			ball.y = height / 2;
			ball.dx = 0;
			ball.dy = ballSpeed;

			paddle.x = (width / 2) - paddle.width / 2;
			paddle.y = height * 0.9;

			for (var x = brickWidth * 0.1; x < width - 2 * brickWidth; x += 2 *brickWidth * 1.1) {
			 	for (var y = brickHeight; y < brickHeight * 4; y += brickHeight * 1.1) {
			 		bricks.push(new Brick(x, y, brickWidth, brickHeight, 1));
			 	}
			}
			break;
		case 2:

			ballSpeed = 12;
			paddleSpeed = 15;
			brickFallSpeed = 0.1

			ball.x = width / 2;
			ball.y = height / 2;
			ball.dx = 0;
			ball.dy = ballSpeed;

			paddle.x = (width / 2) - paddle.width / 2;
			paddle.y = height * 0.9;

		for (var x = 1; x < width / brickWidth; x += 1) {
			for (var y = 1; y < 7; y += 1) {
				if (x - 5> y == 0) {
					bricks.push(new Brick(x * brickWidth * 1.1, y * brickHeight * 1.1, brickWidth, brickHeight, 1));
				}
			}
		}
		delete ball;
	}

}


function draw() {

	c.clearRect(0, 0, width, height);
	c.strokeRect(0, 0, width, height);
	c.fillStyle = "#000022"
	c.fillRect(0, 0, width, height);
	drawBall();
	moveBall();
	drawPaddle();

	if (keyPressed == "left" && paddle.x > 0) {
		paddle.x -= paddleSpeed;
	} else if (keyPressed == "right" && paddle.x + paddle.width < width) {
		paddle.x += paddleSpeed;
	}

	for (var i in bricks) {
		drawBrick(bricks[i]);
	}

	moveBricksDown();

	drawLives();

}

function drawLives() {

	for (var i = 0; i < playerLives; i += 1) {
		c.beginPath();
		c.fillStyle = "red";
		c.arc(i * 15 + 10, height * 0.95, 5, 0, 2 * Math.PI);
		c.fill();
		c.closePath();
	}
}

function Paddle(x, y, width, height) {
	this.x = x;
	this.y = y;
	this.width = width;
	this.height = height;
}

function Ball(x, y, radius, dx, dy) {
	this.x = x;
	this.y = y;
	this.radius = radius;
	this.dx = dx;
	this.dy = dy;

}

function Brick(x, y, width, height, lives) {

	var colors = ["red", "orange", "yellow", "green", "blue"];

	this.x = x;
	this.y = y;
	this.width = width;
	this.height = height;
	this.lives = lives;
	this.color = colors[lives - 1];

}

function drawPaddle() {
	c.fillStyle = "#00f0f0";
	c.beginPath();
	c.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
	c.closePath();
}

var keyPressed = "";

$(document).keydown(function() {

	direction = event.keyCode
	if (direction == 37) {
		keyPressed = "left";
	} else if (direction == 39) {
		keyPressed = "right";
	}
});

$(document).keyup(function() {
	direction = event.keyCode
	if (direction == 37 && keyPressed == "left") {
		keyPressed = "";
	} else if (direction == 39 && keyPressed == "right") {
		keyPressed = "";
	}
});

function drawBall() {

	c.fillStyle = "red";
	c.beginPath();
	c.arc(ball.x, ball.y, ball.radius, 0, 2*Math.PI);
	c.closePath();
	c.fill(); 
}

function drawBrick(brick) {

	c.fillStyle = brick.color;
	c.fillRect(brick.x, brick.y, brick.width, brick.height);

}

function moveBall() {

	ball.x += ball.dx;
	ball.y += ball.dy;

	if (ball.y - ball.radius <= 0 && ball.dy < 0) {
		ball.dy *= -1;
	} else if (ball.y + ball.radius >= height && ball.dy > 0) {
		ball.dy *= -1;
		ballDropped();
	}

	if (ball.x - ball.radius <= 0 && ball.dx < 0) {
		ball.dx *= -1;
	} else if (ball.x + ball.radius >= width && ball.dx > 0) {
		ball.dx *= -1;
	}

	var minPaddleX = paddle.x;
	var maxPaddleX = paddle.x + paddle.width;
	var minPaddleY = paddle.y;
	var maxPaddleY = paddle.y + paddle.height;

	if (ball.x + ball.radius > minPaddleX && ball.x - ball.radius < maxPaddleX && ball.y + ball.radius > minPaddleY && ball.y - ball.radius < maxPaddleY) {
		ball.dy *= -1;
		var diff = ball.x - (paddle.x + paddle.width / 2);
		var percentage = diff / paddle.width;
		ball.dx = percentage * 10;
	}

	for (var i in bricks) {
		var brick = bricks[i];
		var minBrickX = brick.x
		var maxBrickX = brick.x + brick.width;
		var minBrickY = brick.y;
		var maxBrickY = brick.y + brick.height;

		if (ball.x + ball.radius > minBrickX && ball.x - ball.radius < maxBrickX && ball.y + ball.radius > minBrickY && ball.y - ball.radius < maxBrickY) {

			var ballFromLeft = ball.x - minBrickX;
			var ballFromRight = maxBrickX - ball.x;
			var ballFromTop = ball.y - minBrickY;
			var ballFromBottom = maxBrickY - ball.y;

			var distances = [ballFromLeft, ballFromRight, ballFromTop, ballFromBottom];

			distances.sort(function(a, b) {
  				return a - b;
			});

			if (distances[0] == ballFromLeft || distances[0] == ballFromRight) {
				ball.dx *= -1;
				bricks.splice(i, 1);
				if (bricks.length == 0) {
					setLevel(globalLevel + 1);
				}
			} else if (distances[0] == ballFromTop || distances[0] == ballFromBottom) {
				ball.dy *= -1;
				bricks.splice(i, 1);
				if (bricks.length == 0) {
					setLevel(globalLevel + 1);
				}
			}
		}
	}

}

function gameLost() {

	brickFallSpeed = 0;
	ball.dx = 0;
	ball.dy = 0;
	paddleSpeed = 0;

}

function ballDropped() {

	if (playerLives > 1) {
		playerLives -= 1;
	} else {
		gameLost();
	}

}

function moveBricksDown() {

	for (var i in bricks) {
		if (bricks[i] != undefined) {
			bricks[i].y += brickFallSpeed;
			if (bricks[i].y > height * 0.9) {
				if (playerLives > 1) {
					playerLives -= 1;
				} else {
					gameLost();
				}
				setLevel(globalLevel);
			}
		}
	}
}

</script>


<style>

</style>

</html>
